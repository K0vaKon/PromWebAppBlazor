@page "/admin-panel"
@inject HttpClient Http
@using PromWebAppBalzor.Models

<div class="admin-container">
    <h3>Admin panel (@(pendingPhotos?.Count ?? 0))</h3>

    @if (pendingPhotos == null)
    {
        <div class="spinner-border text-primary" role="status"></div>
    }
    else if (pendingPhotos.Count == 0)
    {
        <p>No pending photos.</p>
    }
    else
    {
        <div class="photo-grid">
            @foreach (var photo in pendingPhotos)
            {
                <div class="photo-card">
                    <div class="photo-wrapper">
                        @* ТЕПЕРЬ ВАЖНО: Используем photo.FileName *@
                        <img src="@($"http://localhost:5036/uploads/{photo.FileName}")"
                             loading="lazy"
                             decoding="async"
                             alt="Pending photo" />
                    </div>

                    <div class="photo-info">
                        @* ТЕПЕРЬ ВАЖНО: Выводим имя автора из базы *@
                        <span class="user-name">
                            👤 @(photo.Sender?.Name ?? "Unknown")
                        </span>
                        <br />
                        <small style="color: gray; font-size: 0.8em;">
                            @photo.Tijd.ToString("dd.MM.yyyy HH:mm")
                        </small>
                    </div>

                    <div class="actions">
                        @* Передаем весь объект photo *@
                        <button class="btn-approve" @onclick="() => Approve(photo)">Approve</button>
                        <button class="btn-reject" @onclick="() => Reject(photo)">Reject</button>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    // 1. ИЗМЕНЕНИЕ: Теперь это список объектов Photo, а не string
    private List<Photo>? pendingPhotos;

    protected override async Task OnInitializedAsync()
    {
        await LoadPending();
    }

    async Task LoadPending()
    {
        try
        {
            // 2. ИЗМЕНЕНИЕ: Читаем JSON как список объектов
            pendingPhotos = await Http.GetFromJsonAsync<List<Photo>>("http://localhost:5036/api/Photo/pending");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading photos: {ex.Message}");
        }
    }

    // 3. ИЗМЕНЕНИЕ: Метод принимает объект Photo
    async Task Approve(Photo photo)
    {
        var response = await Http.PostAsync($"http://localhost:5036/api/Photo/approve/{photo.FileName}", null);
        if (response.IsSuccessStatusCode)
        {
            pendingPhotos?.Remove(photo);
        }
    }

    async Task Reject(Photo photo)
    {
        var response = await Http.PostAsync($"http://localhost:5036/api/Photo/reject/{photo.FileName}", null);
        if (response.IsSuccessStatusCode)
        {
            pendingPhotos?.Remove(photo);
        }
        else
        {
            Console.WriteLine($"Reject failed: {response.StatusCode}");
        }
    }
}