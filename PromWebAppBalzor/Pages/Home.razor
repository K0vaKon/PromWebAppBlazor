@page "/"
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http

<div id="WebApp">
    <div id="HomeTop">
        <h1>Welkom op de bal!</h1>
    </div>

    <div id="content">
        @* Foto kiezen *@
        @if (imgSrc == null)
        {
            <label class="btn-upload">
                KIES EEN FOTO
                <InputFile OnChange="HandleFileSelected" hidden accept="image/*" />
            </label>
        }

        @* Confirm button *@
        @if (imgSrc != null)
        {
            <div class="preview-animation text-center">
                <img src="@imgSrc" class="img-preview" style="max-width: 100%; border-radius: 15px;" />

                @if (!isUploading)
                {
                    <div class="mt-3">
                        <button class="btn-confirm" @onclick="UploadToServer">
                            STUREN
                        </button>
                        <button class="btn-cancel" @onclick="CancelSelection">
                            CANCEL
                        </button>
                    </div>
                }
            </div>
        }

        @* Loading status *@
        @if (isUploading)
        {
            <div class="loader-container centralize">
                <div class="spinner-border text-warning" role="status"></div>
                <p>Uploading... @uploadProgress%</p>
            </div>
        }

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <p class="status-text">@statusMessage</p>
        }
    </div>
</div>

@code {
    private string? imgSrc;
    private IBrowserFile? selectedFile;
    private bool isUploading = false;
    private string statusMessage = "";
    private int uploadProgress = 0; // Для красоты

    // Метод 1: Только предпросмотр
    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        statusMessage = "";
        selectedFile = e.File;

        if (selectedFile != null)
        {
            // Делаем легкую копию для показа на экране (JPEG)
            var resizedFile = await selectedFile.RequestImageFileAsync("image/jpeg", 800, 800);
            var buffer = new byte[resizedFile.Size];
            await resizedFile.OpenReadStream(1024 * 1024 * 15).ReadAsync(buffer);

            imgSrc = $"data:image/jpeg;base64,{Convert.ToBase64String(buffer)}";
            StateHasChanged();
        }
    }

    // Метод 2: Сама отправка
    private async Task UploadToServer()
    {
        if (selectedFile == null) return;

        isUploading = true;
        statusMessage = "Momentje...";
        uploadProgress = 10;
        StateHasChanged();

        try
        {
            using var content = new MultipartFormDataContent();
            // Отправляем оригинальный файл (или можно тоже уменьшенный для скорости)
            var fileContent = new StreamContent(selectedFile.OpenReadStream(1024 * 1024 * 15));
            content.Add(fileContent, "file", selectedFile.Name);

            uploadProgress = 50;
            var response = await Http.PostAsync("api/upload", content);

            if (response.IsSuccessStatusCode)
            {
                uploadProgress = 100;
                statusMessage = "✅ Gelukt!";
                await Task.Delay(2000);
                CancelSelection();
            }
            else
            {
                statusMessage = "❌ Er is iets mis gegaan.";
            }
        }
        catch (Exception ex)
        {
            statusMessage = "❌ Er is iets mis gegaan.";
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    private void CancelSelection()
    {
        imgSrc = null;
        selectedFile = null;
        statusMessage = "";
        uploadProgress = 0;
    }
}