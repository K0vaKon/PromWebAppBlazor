@page "/"
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http

<div id="WebApp">
    <div id="HomeTop">
        <h1>Welkom op het bal!</h1>
    </div>

    <div id="content">
        @* Выбор фото *@
        @if (imgSrc == null)
        {
            <label class="btn-upload">
                KIES EEN FOTO
                <InputFile OnChange="HandleFileSelected" hidden accept="image/*" />
            </label>
        }

        @* Превью и кнопки *@
        @if (imgSrc != null)
        {
            <div class="preview-animation text-center">
                <img src="@imgSrc" class="img-preview" style="max-width: auto; border-radius: 15px;" />

                @if (!isUploading)
                {
                    <div class="mt-3">
                        <button class="btn-confirm" @onclick="UploadToServer">
                            STUREN
                        </button>
                        <button class="btn-cancel" @onclick="CancelSelection">
                            CANCEL
                        </button>
                    </div>
                }
            </div>
        }

        @* Статус загрузки *@
        @if (isUploading)
        {
            <div class="loader-container centralize">
                <div class="spinner-border text-warning" role="status"></div>
                <p>Uploading... @uploadProgress%</p>
            </div>
        }

        @if (!string.IsNullOrEmpty(statusMessage))
        {
            <p class="status-text">@statusMessage</p>
        }
    </div>
</div>

@code {
    private string? imgSrc;
    private byte[]? fileBytes; // Сохраняем байты здесь, чтобы избежать ошибки _blazorFilesById
    private string? fileName;
    private bool isUploading = false;
    private string statusMessage = "";
    private int uploadProgress = 0;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        statusMessage = "";
        var file = e.File;

        if (file != null)
        {
            try
            {
                // Сразу считываем файл в массив байтов (макс. 15МБ)
                using var stream = file.OpenReadStream(1024 * 1024 * 15);
                fileBytes = new byte[file.Size];
                await stream.ReadAsync(fileBytes);
                fileName = file.Name;

                // Создаем превью из байтов
                imgSrc = $"data:{file.ContentType};base64,{Convert.ToBase64String(fileBytes)}";
                StateHasChanged();
            }
            catch (Exception ex)
            {
                statusMessage = "Fout при загрузке файла.";
                Console.WriteLine(ex.Message);
            }
        }
    }

    private async Task UploadToServer()
    {
        if (fileBytes == null) return;

        isUploading = true;
        statusMessage = "Verzenden naar het bal...";
        uploadProgress = 20;
        StateHasChanged(); 

        try
        {
            using var content = new MultipartFormDataContent();
            var fileContent = new ByteArrayContent(fileBytes);
            content.Add(fileContent, "file", fileName ?? "image.jpg");

            var response = await Http.PostAsync("http://localhost:5036/api/Photo/upload", content);

            if (response.IsSuccessStatusCode)
            {
                uploadProgress = 100;
                statusMessage = "✅ Foto succesvol gedeeld!";
                StateHasChanged(); // ВАЖНО: Форсируем обновление, чтобы показать успех

                await Task.Delay(3000); // Ждем 3 секунды, чтобы ты успел прочитать сообщение
                CancelSelection();
            }
            else
            {
                statusMessage = "❌ Server fout: " + response.StatusCode;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            statusMessage = "❌ Verbindingsfout.";
            Console.WriteLine(ex.ToString());
            StateHasChanged();
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    private void CancelSelection()
    {
        imgSrc = null;
        fileBytes = null;
        fileName = null;
        statusMessage = "";
        uploadProgress = 0;
    }
}